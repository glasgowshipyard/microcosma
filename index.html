<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microcosma: ReTail Risk Hedgehog</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶î</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.bunny.net/css?family=jetbrains-mono:400,700" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        * {
            font-family: 'JetBrains Mono', monospace;
        }

        :root {
            --bg-start: #fafafa;
            --bg-end: #f5f5f5;
            --text: #1a1a1a;
            --text-muted: #666;
            --border: #e0e0e0;
            --card-bg: #ffffff;
            --gradient-1: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
            --gradient-2: linear-gradient(135deg, #f472b6 0%, #fb923c 100%);
            --gradient-3: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --input-bg: #fafafa;
            --shadow: rgba(0, 0, 0, 0.05);
            --accent: #a78bfa;
        }

        [data-theme="dark"] {
            --bg-start: #0a0a0a;
            --bg-end: #1a1a1a;
            --text: #e5e5e5;
            --text-muted: #a0a0a0;
            --border: #333;
            --card-bg: #1f1f1f;
            --input-bg: #2a2a2a;
            --shadow: rgba(255, 255, 255, 0.03);
        }

        body {
            background: linear-gradient(to bottom, var(--bg-start), var(--bg-end));
            color: var(--text);
            min-height: 100vh;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px var(--shadow);
        }

        .gradient-text {
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 1.5rem;
            transition: transform 0.2s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        input[type="number"] {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            background: var(--gradient-1);
            transition: transform 0.2s, opacity 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--gradient-2);
        }

        summary {
            cursor: pointer;
            user-select: none;
        }

        summary:hover {
            color: var(--text);
        }

        /* Info icon popup styles */
        .info-icon {
            display: inline-block;
            width: 1.2em;
            height: 1.2em;
            line-height: 1.2em;
            text-align: center;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            font-size: 0.75em;
            cursor: pointer;
            margin-left: 0.3em;
            vertical-align: middle;
            transition: transform 0.2s, opacity 0.2s;
        }

        .info-icon:hover {
            transform: scale(1.1);
            opacity: 0.9;
        }

        .info-popup {
            display: none;
            margin-top: 0.5em;
            padding: 0.75em;
            border-radius: 0.5em;
            background: var(--input-bg);
            border-left: 3px solid var(--accent);
            font-size: 0.85em;
            line-height: 1.6;
        }

        .info-popup.show {
            display: block;
        }

        /* Mobile responsive typography and spacing */
        @media (max-width: 640px) {
            .header-hedgehog {
                font-size: 3rem;
            }
            .header-title {
                font-size: 2rem;
            }
            .header-subtitle {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="max-w-3xl mx-auto px-4 sm:px-6 py-8 sm:py-12">

        <!-- Header -->
        <header class="mb-12 sm:mb-16">
            <div class="flex justify-between items-center mb-6 sm:mb-8">
                <div class="flex items-center gap-3 sm:gap-6">
                    <div class="header-hedgehog text-5xl sm:text-8xl">ü¶î</div>
                    <div>
                        <h1 class="header-title text-3xl sm:text-5xl font-bold mb-1 sm:mb-2">
                            <span class="gradient-text">Microcosma</span>
                        </h1>
                        <p class="header-subtitle text-xs sm:text-sm" style="color: var(--text-muted);">ReTail Risk Hedgehog</p>
                    </div>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <span id="theme-icon">üåô</span>
                </div>
            </div>

            <p style="color: var(--text-muted); line-height: 1.8; max-width: 60ch;">
                A systematic tool for implementing a lossy, retail-scale black swan insurance strat.
                Inspired by Taleb and Spitznagel. Continuously pay a small premium for deep OTM SPY puts.
                Most years they expire worthless. When catastrophe strikes, maybe you offset some losses.
            </p>
        </header>

        <!-- Market Data Card -->
        <section class="card rounded-lg p-4 sm:p-8 mb-6 sm:mb-8">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">Market Data</h2>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                <div>
                    <div class="text-xs mb-2" style="color: var(--text-muted);">SPY Price</div>
                    <div class="text-2xl sm:text-3xl font-bold" id="spy-price">--</div>
                    <div class="text-xs mt-1" style="color: var(--text-muted);">Previous Close</div>
                </div>
                <div>
                    <div class="text-xs mb-2" style="color: var(--text-muted);">VIX</div>
                    <input
                        type="number"
                        id="vix-manual"
                        value="16"
                        step="0.1"
                        class="text-2xl sm:text-3xl font-bold w-full rounded px-2 py-1"
                        placeholder="16">
                    <div class="text-xs mt-1" style="color: var(--text-muted);">Manual Entry</div>
                </div>
                <div>
                    <div class="text-xs mb-2" style="color: var(--text-muted);">Budget Multiplier</div>
                    <div class="text-2xl sm:text-3xl font-bold" id="vix-multiplier">--</div>
                    <div class="text-xs mt-1" style="color: var(--text-muted);">VIX-Adjusted</div>
                </div>
            </div>

            <div class="p-3 rounded text-xs mb-4" style="background: var(--input-bg); line-height: 1.6;">
                <strong>VIX Budget Rule:</strong> VIX &lt;20 = 100% | VIX 20-30 = 75% | VIX &gt;30 = 50%<br>
                Buy more insurance when cheap, less when expensive.
            </div>

            <p class="text-xs mb-4" style="color: var(--text-muted);">
                Check current VIX at CBOE.com. Free tier = previous close for SPY.
            </p>

            <button onclick="refreshData()" class="btn text-white font-bold py-3 px-6 rounded-lg w-full mb-4">
                Refresh SPY Data
            </button>

            <details class="text-sm">
                <summary style="color: var(--text-muted);">Override SPY manually</summary>
                <div class="mt-3">
                    <input
                        type="number"
                        id="spy-manual"
                        step="0.01"
                        class="w-full rounded px-4 py-2"
                        placeholder="Leave blank to use API data">
                </div>
            </details>
        </section>

        <!-- Calculator Card -->
        <section class="card rounded-lg p-4 sm:p-8 mb-6 sm:mb-8">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">Your Hedge</h2>

            <div class="space-y-6">
                <div>
                    <label class="block text-xs sm:text-sm mb-2" style="color: var(--text-muted);">Portfolio SPY Exposure ($)</label>
                    <input
                        type="number"
                        id="portfolio-exposure"
                        value="100000"
                        class="w-full rounded px-3 sm:px-4 py-2 sm:py-3 text-base sm:text-lg font-bold">
                    <p class="text-xs mt-1" style="color: var(--text-muted);">
                        Value of S&P 500 holdings you want to hedge
                    </p>
                </div>

                <div>
                    <label class="block text-xs sm:text-sm mb-2" style="color: var(--text-muted);">Max Spend Per Purchase ($)</label>
                    <input
                        type="number"
                        id="per-purchase-budget"
                        value="250"
                        class="w-full rounded px-3 sm:px-4 py-2 sm:py-3 text-base sm:text-lg font-bold">
                    <p class="text-xs mt-1" style="color: var(--text-muted);">
                        How much you want to spend each time you buy
                    </p>
                </div>

                <div>
                    <label class="block text-xs sm:text-sm mb-2" style="color: var(--text-muted);">Buy Frequency</label>
                    <select id="buy-frequency" class="w-full rounded px-3 sm:px-4 py-2 sm:py-3 text-base sm:text-lg font-bold" style="background: var(--input-bg); border: 1px solid var(--border); color: var(--text);">
                        <option value="12">Monthly</option>
                        <option value="4" selected>Quarterly</option>
                        <option value="2">Semi-Annual</option>
                        <option value="1">Annual</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs sm:text-sm mb-2" style="color: var(--text-muted);">Strike Distance</label>
                    <select id="strike-distance" class="w-full rounded px-3 sm:px-4 py-2 sm:py-3 text-base sm:text-lg font-bold" style="background: var(--input-bg); border: 1px solid var(--border); color: var(--text);">
                        <option value="10">10% OTM</option>
                        <option value="20">20% OTM</option>
                        <option value="30" selected>30% OTM (Black Swan)</option>
                        <option value="40">40% OTM (Deep OTM)</option>
                        <option value="50">50% OTM (Extreme)</option>
                    </select>
                    <p class="text-xs mt-1" style="color: var(--text-muted);" id="strike-price-display">
                        Strike: --
                    </p>
                </div>

                <div>
                    <label class="block text-xs sm:text-sm mb-2" style="color: var(--text-muted);">Days to Expiration</label>
                    <select id="days-to-expiration" class="w-full rounded px-3 sm:px-4 py-2 sm:py-3 text-base sm:text-lg font-bold" style="background: var(--input-bg); border: 1px solid var(--border); color: var(--text);">
                        <option value="30">30 Days</option>
                        <option value="60">60 Days</option>
                        <option value="90" selected>90 Days</option>
                        <option value="180">180 Days</option>
                    </select>
                </div>

                <div class="card p-4" style="background: var(--input-bg);">
                    <p class="text-xs mb-2" style="color: var(--text-muted);">
                        Look up this contract on <a href="#" id="yahoo-link" target="_blank" class="underline" style="color: var(--accent);">Yahoo Finance</a>
                    </p>
                    <div class="text-sm font-bold mb-2" id="contract-description">--</div>
                    <label class="block text-xs mb-1" style="color: var(--text-muted);">Ask Price (per share, will auto-multiply by 100)</label>
                    <input
                        type="number"
                        id="put-premium"
                        value="0.50"
                        step="0.01"
                        placeholder="e.g., 0.64"
                        class="w-full rounded px-3 py-2 text-base font-bold">
                </div>
            </div>

        </section>

        <!-- Results Card -->
        <section id="results" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8">
                <div class="card rounded-lg p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-bold mb-3 sm:mb-4 gradient-text">Per Purchase</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Contracts to Buy</div>
                            <div class="text-2xl sm:text-3xl font-bold" id="contracts-needed">--</div>
                        </div>
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Cost</div>
                            <div class="text-2xl sm:text-3xl font-bold" id="total-capital">--</div>
                        </div>
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Budget Allocated</div>
                            <div class="text-base sm:text-lg" id="adjusted-budget">--</div>
                        </div>
                    </div>
                </div>

                <div class="card rounded-lg p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-bold mb-3 sm:mb-4 gradient-text">Annual Total</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Total Contracts</div>
                            <div class="text-2xl sm:text-3xl font-bold" id="max-exposure">--</div>
                        </div>
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Total Annual Cost</div>
                            <div class="text-2xl sm:text-3xl font-bold" id="contracts-affordable">--</div>
                        </div>
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Protection Level</div>
                            <div class="text-base sm:text-lg" id="coverage-info">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card rounded-lg p-4 sm:p-6 mb-6 sm:mb-8">
                <h3 class="text-base sm:text-lg font-bold mb-3">Summary</h3>
                <div class="text-xs sm:text-sm leading-relaxed" style="color: var(--text-muted);" id="explanation"></div>
            </div>

            <div class="card rounded-lg p-4 sm:p-6 mb-6 sm:mb-8">
                <h3 class="text-base sm:text-lg font-bold mb-3 sm:mb-4 gradient-text">Exposure Capacity</h3>
                <p class="text-xs mb-3 sm:mb-4" style="color: var(--text-muted);">
                    With your budget, what's the maximum portfolio size you can hedge?
                </p>
                <div class="text-xs sm:text-sm leading-relaxed" style="color: var(--text-muted);" id="exposure-capacity"></div>
            </div>

            <!-- Historical Crash Scenarios -->
            <div class="card rounded-lg p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-bold mb-3 sm:mb-4 gradient-text">Historical Crash Scenarios</h3>
                <p class="text-xs mb-4 sm:mb-6" style="color: var(--text-muted);">
                    What would your hedge have returned during actual market catastrophes?
                </p>

                <div class="space-y-4 sm:space-y-6">
                    <!-- 2008 Financial Crisis -->
                    <div class="p-3 sm:p-4 rounded" style="background: var(--input-bg); border-left: 4px solid #ec4899;">
                        <div class="mb-2 sm:mb-3">
                            <div class="text-xs sm:text-sm font-bold">2008 Financial Crisis</div>
                            <div class="text-xs" style="color: var(--text-muted);">Oct 2007 peak ‚Üí Mar 2009 trough</div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 sm:gap-4 text-xs mb-2 sm:mb-3">
                            <div>
                                <div style="color: var(--text-muted);">VIX Peak</div>
                                <div class="font-bold">89.53</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted);">SPY Peak</div>
                                <div class="font-bold">$157</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted);">SPY Bottom</div>
                                <div class="font-bold">$68</div>
                            </div>
                        </div>
                        <div class="text-xs sm:text-sm leading-relaxed" id="crash-2008"></div>
                    </div>

                    <!-- COVID-19 Crash -->
                    <div class="p-3 sm:p-4 rounded" style="background: var(--input-bg); border-left: 4px solid #f472b6;">
                        <div class="mb-2 sm:mb-3">
                            <div class="text-xs sm:text-sm font-bold">COVID-19 Crash</div>
                            <div class="text-xs" style="color: var(--text-muted);">Feb 2020 peak ‚Üí Mar 2020 trough</div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 sm:gap-4 text-xs mb-2 sm:mb-3">
                            <div>
                                <div style="color: var(--text-muted);">VIX Peak</div>
                                <div class="font-bold">82.69</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted);">SPY Peak</div>
                                <div class="font-bold">$339</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted);">SPY Bottom</div>
                                <div class="font-bold">$218</div>
                            </div>
                        </div>
                        <div class="text-xs sm:text-sm leading-relaxed" id="crash-2020"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer with Disclaimer -->
        <footer class="mt-16 pt-8 border-t" style="border-color: var(--border);">
            <details class="mb-8">
                <summary class="text-lg font-bold mb-4" style="color: var(--text-muted);">
                    Disclaimer: Read And Re-Read This
                </summary>
                <div class="mt-4 space-y-4 text-sm leading-relaxed max-w-65ch" style="color: var(--text-muted);">
                    <p>
                        Options trading is dangerous. You can lose 100% of your premium. Deep OTM puts expire
                        worthless more often than not.
                    </p>

                    <p>
                        This is insurance, not a get-rich-quick scheme. You pay a premium every year for protection
                        you will probably never collect on. Like Taleb says: you look like an idiot for years
                        until the day you look like a genius. Can you handle looking like an idiot?
                    </p>

                    <p>
                        You need to understand convexity. You need to understand volatility. You need to understand
                        that market makers are not your friends. You need to understand that liquidity can disappear
                        faster than your unrealized gains in a crash.
                    </p>

                    <p>
                        <strong>This tool does NOT:</strong> Place trades for you. Guarantee any returns.
                        Constitute financial advice. Protect you from your own stupidity. Account for taxes,
                        commissions, slippage, or the heat death of the universe.
                    </p>

                    <p>
                        <strong>What this IS:</strong> A calculator for implementing a fairly pathetic Taleb/Spitznagel-style
                        tail hedge at retail (micro)scale. You set a budget. You buy disaster insurance. Most months/years
                        it expires worthless (you lose all your money). When the apocalypse comes, you might offset some losses.
                    </p>

                    <p>
                        If you do not know what vega, skew, or gamma mean, you have no business trading options.
                        Go read Taleb's <a href="https://bookshop.org/a/89518/9780471152804" target="_blank" class="underline" style="color: var(--accent);">Dynamic Hedging</a> and Spitznagel's <a href="https://bookshop.org/a/89518/9781118347034" target="_blank" class="underline" style="color: var(--accent);">The Dao of Capital</a> and <a href="https://bookshop.org/a/89518/9781119401797" target="_blank" class="underline" style="color: var(--accent);">Safe Haven</a> first.
                        Seriously. Close this tab and go read.
                    </p>

                    <p>
                        <strong>‚ö†Ô∏è warning:</strong> This strategy can and will lead to total financial
                        obliteration if you mess it up. Do it at your own risk. You're responsible for
                        your losses, margin calls, and existential crises. This tiny app isn't.
                    </p>
                </div>
            </details>

            <div class="text-center text-sm" style="color: var(--text-muted);">
                <p class="mb-2">Become the Hedgehog ü¶î</p>
                <p>Not financial advice. For educational purposes only. All the math is probably wrong anyway</p>
                <p class="mt-4 text-xs">Last updated: <span id="last-updated">Never</span></p>
            </div>
        </footer>
    </div>

    <script>
        // Theme management
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            document.getElementById('theme-icon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme based on system preference or saved preference
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('theme-icon').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // State
        let marketData = {
            spyPrice: null,
            vix: null,
            vixMultiplier: null,
            lastUpdated: null
        };

        // VIX-Based Budget Adjustment
        function calculateVixMultiplier(vix) {
            if (vix < 20) return 1.0;
            if (vix >= 20 && vix <= 30) return 0.75;
            return 0.5;
        }

        // Fetch real market data from Massive API
        async function fetchMarketData() {
            try {
                const spyResponse = await fetch(`${CONFIG.MASSIVE_BASE_URL}/v2/aggs/ticker/${CONFIG.SYMBOLS.SPY}/prev?adjusted=true&apiKey=${CONFIG.MASSIVE_API_KEY}`);

                if (!spyResponse.ok) {
                    const errorText = await spyResponse.text();
                    throw new Error(`Failed to fetch SPY data: ${spyResponse.status}`);
                }

                const spyData = await spyResponse.json();
                const spyPrice = spyData.results?.[0]?.c;

                if (!spyPrice) {
                    throw new Error('No SPY price data available');
                }

                const vixInput = document.getElementById('vix-manual');
                const vixValue = parseFloat(vixInput.value) || 16;

                return {
                    spyPrice: spyPrice,
                    vix: vixValue,
                    vixMultiplier: calculateVixMultiplier(vixValue),
                    lastUpdated: new Date()
                };
            } catch (error) {
                console.error('Error fetching market data:', error);
                alert(`Failed to fetch market data: ${error.message}\n\nPlease check your API key or enter data manually.`);

                const vixInput = document.getElementById('vix-manual');
                const spyInput = document.getElementById('spy-manual');

                const vixValue = parseFloat(vixInput.value) || 16;
                const spyPrice = parseFloat(spyInput.value) || 600;

                return {
                    spyPrice: spyPrice,
                    vix: vixValue,
                    vixMultiplier: calculateVixMultiplier(vixValue),
                    lastUpdated: new Date()
                };
            }
        }

        // Update market data display
        function updateMarketDataDisplay() {
            if (!marketData.spyPrice) return;

            const spyManualInput = document.getElementById('spy-manual');
            const displayPrice = spyManualInput.value ? parseFloat(spyManualInput.value) : marketData.spyPrice;
            document.getElementById('spy-price').textContent = `$${displayPrice.toFixed(2)}`;

            const vixInput = document.getElementById('vix-manual');
            const currentVix = parseFloat(vixInput.value) || marketData.vix;
            const multiplier = calculateVixMultiplier(currentVix);

            document.getElementById('vix-multiplier').textContent = `${(multiplier * 100).toFixed(0)}%`;
            document.getElementById('last-updated').textContent = marketData.lastUpdated.toLocaleString();

            updateStrikeDisplay();
        }

        // Update strike price display and Yahoo link
        function updateStrikeDisplay() {
            const spyManualInput = document.getElementById('spy-manual');
            const spyPrice = spyManualInput.value ? parseFloat(spyManualInput.value) : marketData.spyPrice;

            if (!spyPrice) return;

            const strikeDistance = parseFloat(document.getElementById('strike-distance').value);
            const daysToExp = document.getElementById('days-to-expiration').value;

            const strikePrice = Math.floor(spyPrice * (1 - strikeDistance / 100));

            // Calculate approximate expiration date
            const today = new Date();
            const expirationDate = new Date(today);
            expirationDate.setDate(today.getDate() + parseInt(daysToExp));

            // Format for display
            const expirationString = expirationDate.toISOString().split('T')[0];

            document.getElementById('strike-price-display').textContent = `Strike: $${strikePrice} (${strikeDistance}% below current)`;
            document.getElementById('contract-description').textContent = `SPY ${expirationString} $${strikePrice}P`;

            // Generate Yahoo Finance link
            const yahooLink = `https://finance.yahoo.com/quote/SPY/options?date=${Math.floor(expirationDate.getTime() / 1000)}`;
            document.getElementById('yahoo-link').href = yahooLink;
        }

        // Update VIX multiplier when VIX input changes
        function updateVixMultiplier() {
            const vixInput = document.getElementById('vix-manual');
            const vixValue = parseFloat(vixInput.value);
            if (vixValue && vixValue > 0) {
                marketData.vix = vixValue;
                marketData.vixMultiplier = calculateVixMultiplier(vixValue);
                document.getElementById('vix-multiplier').textContent = `${(marketData.vixMultiplier * 100).toFixed(0)}%`;
            }
        }

        // Core calculation: PROFIT-BASED (subtracts premium paid)
        function calculateHedge(portfolio, perPurchaseBudget, buyFrequency, putPremiumPerShare, vixMultiplier, strikeDistance, spyPrice) {
            // VIX adjustment: scale down purchases when VIX is high (insurance expensive)
            const vixAdjustedBudget = perPurchaseBudget * vixMultiplier;

            // Convert per-share price to per-contract price (1 contract = 100 shares)
            const costPerContract = putPremiumPerShare * 100;

            // How many contracts can you afford per purchase?
            const contractsPerPurchase = Math.floor(vixAdjustedBudget / costPerContract);

            // Actual cost per purchase
            const actualCostPerPurchase = contractsPerPurchase * costPerContract;

            // Annual totals
            const totalAnnualCost = actualCostPerPurchase * buyFrequency;

            // CRITICAL: For a single crash event, only ONE purchase cycle's contracts are active
            // If you buy quarterly (4x/year), only ~3 contracts are active during any single crash
            // NOT all 12 annual contracts
            const activeContractsInCrash = contractsPerPurchase;

            // Calculate PROFIT at strike using volatility-based approximation
            const strikePrice = Math.floor(spyPrice * (1 - strikeDistance / 100));
            const portfolioLossAtStrike = portfolio * (strikeDistance / 100);

            // FIX: At strike, intrinsic value is ZERO for a put. Value comes from implied volatility.
            // In a crash reaching the strike (e.g., 30% drop), VIX typically spikes to ~65-80.
            // Using Black-Scholes approximation: ATM put with high vol (~65%) is worth ~12% of strike
            // This accounts for remaining time value and volatility (not just intrinsic value)
            const estimatedOptionPriceAtStrike = strikePrice * 0.12;

            // Net profit = Estimated option value at strike - Premium paid
            const profitPerContractAtStrike = (estimatedOptionPriceAtStrike - putPremiumPerShare) * 100;

            // Total payout from ACTIVE contracts only
            const totalPayoutAtStrike = profitPerContractAtStrike * activeContractsInCrash;

            // What % of portfolio loss is covered?
            const coveragePercent = (totalPayoutAtStrike / portfolioLossAtStrike) * 100;

            return {
                contractsPerPurchase,
                actualCostPerPurchase,
                vixAdjustedBudget,
                activeContractsInCrash,
                totalAnnualCost,
                costPerContract,
                coveragePercent,
                totalPayoutAtStrike,
                portfolioLossAtStrike
            };
        }

        // --- BLACK-SCHOLES HELPER FUNCTIONS ---

        // Standard Normal Cumulative Distribution Function (needed for Black-Scholes)
        function stdNormCDF(x) {
            var t = 1 / (1 + 0.2316419 * Math.abs(x));
            var d = 0.3989423 * Math.exp(-x * x / 2);
            var prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
            if (x > 0) prob = 1 - prob;
            return prob;
        }

        // Black-Scholes Put Valuation
        function blackScholesPut(S, K, T, r, sigma) {
            var d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
            var d2 = d1 - sigma * Math.sqrt(T);
            return K * Math.exp(-r * T) * stdNormCDF(-d2) - S * stdNormCDF(-d1);
        }

        // --- HISTORICAL CRASH CALCULATOR WITH BLACK-SCHOLES ---

        function calculateCrashScenario(crashName, crashVix, historicalPeakSPY, historicalBottomSPY, portfolio, currentSPY, activeContractsInCrash, premiumPerShare, strikeDistance) {
            // 1. Calculate the Strike you would have owned
            const strikePrice = Math.floor(historicalPeakSPY * (1 - strikeDistance / 100));
            const historicalDropPercent = ((historicalPeakSPY - historicalBottomSPY) / historicalPeakSPY) * 100;

            // 2. Estimate the Option Value at the Crash Bottom using Black-Scholes
            // Assumption: ~45 days (0.12 years) remaining on contract during crash
            const T = 0.12;
            const r = 0.04; // Risk-free rate assumption (4%)
            const sigma = crashVix / 100; // Convert VIX (e.g., 82) to Volatility (0.82)

            const estimatedOptionPrice = blackScholesPut(historicalBottomSPY, strikePrice, T, r, sigma);

            // 3. Calculate Profit: (Estimated Sell Price - Cost Basis) √ó 100 shares
            const profitPerContract = (estimatedOptionPrice - premiumPerShare) * 100;

            // Only active contracts from ONE purchase cycle pay out
            const totalProfit = profitPerContract * activeContractsInCrash;
            const portfolioLoss = portfolio * (historicalDropPercent / 100);

            // Avoid "NaN" if there's no profit/loss overlap (rare edge case)
            let recoveryPercent = 0;
            if (portfolioLoss > 0) {
                recoveryPercent = (totalProfit / portfolioLoss) * 100;
            }

            // Formatting the output
            let statusNote = "";
            if (historicalBottomSPY > strikePrice) {
                statusNote = `<span style="color: var(--text-muted);">(Strike not breached, but high VIX payout)</span>`;
            } else {
                statusNote = `<span style="color: #10b981;">(ITM + Volatility Premium)</span>`;
            }

            return `
                -${historicalDropPercent.toFixed(0)}% drop | Strike: $${strikePrice} ${statusNote}<br>
                Est. Option Value: $${(estimatedOptionPrice*100).toLocaleString(undefined, {maximumFractionDigits:0})} per contract
                <span class="info-icon" onclick="toggleInfo('historical-${crashName.replace(/\s+/g, '-').toLowerCase()}-popup')">‚Ñπ</span>
                <div id="historical-${crashName.replace(/\s+/g, '-').toLowerCase()}-popup" class="info-popup">
                    <strong>VIX-Adjusted Valuation:</strong><br>
                    Calculated using the actual VIX peak of ${crashVix.toFixed(2)} during this crash. This captures the massive "Panic Premium" that makes deep OTM puts valuable during market collapses.
                </div>
                <br>
                <strong>Net Profit: $${totalProfit.toLocaleString(undefined, {maximumFractionDigits:0})}</strong> | Recovered <strong>${recoveryPercent.toFixed(0)}%</strong> of loss
            `;
        }

        // Calculate and display results (auto-updates)
        function calculate() {
            const portfolio = parseFloat(document.getElementById('portfolio-exposure').value);
            const perPurchaseBudget = parseFloat(document.getElementById('per-purchase-budget').value);
            const buyFrequency = parseFloat(document.getElementById('buy-frequency').value);
            const strikeDistance = parseFloat(document.getElementById('strike-distance').value);
            const putPremium = parseFloat(document.getElementById('put-premium').value);

            if (!marketData.vix || !portfolio || !perPurchaseBudget || !buyFrequency || !strikeDistance || !putPremium || !marketData.spyPrice) {
                return;
            }

            const spyManualInput = document.getElementById('spy-manual');
            const spyPrice = spyManualInput.value ? parseFloat(spyManualInput.value) : marketData.spyPrice;

            const result = calculateHedge(portfolio, perPurchaseBudget, buyFrequency, putPremium, marketData.vixMultiplier, strikeDistance, spyPrice);

            // Update results display
            document.getElementById('contracts-needed').textContent = result.contractsPerPurchase;
            document.getElementById('total-capital').textContent = `$${result.actualCostPerPurchase.toFixed(2)}`;
            document.getElementById('adjusted-budget').textContent = `$${result.vixAdjustedBudget.toFixed(2)}`;

            document.getElementById('max-exposure').textContent = result.activeContractsInCrash;
            document.getElementById('contracts-affordable').textContent = `$${result.totalAnnualCost.toFixed(2)}`;
            document.getElementById('coverage-info').textContent = `${result.coveragePercent.toFixed(0)}% of loss`;

            const frequencyText = buyFrequency == 12 ? 'month' : buyFrequency == 4 ? 'quarter' : buyFrequency == 2 ? 'half-year' : 'year';

            const explanation = `
                <strong>Portfolio Coverage (Single Crash Event):</strong><br>
                Portfolio: $${portfolio.toLocaleString()} | Loss at ${strikeDistance}% crash: $${result.portfolioLossAtStrike.toLocaleString()}<br>
                Net profit from ${result.activeContractsInCrash} active contracts: $${result.totalPayoutAtStrike.toLocaleString()} = <strong>${result.coveragePercent.toFixed(1)}% coverage</strong>
                <span class="info-icon" onclick="toggleInfo('coverage-info-popup')">‚Ñπ</span>
                <div id="coverage-info-popup" class="info-popup">
                    <strong>Why not 100% coverage?</strong><br>
                    Universa/Spitznagel strategies typically aim for 50-60% coverage. The goal isn't to be flat, but to have enough <strong>liquid cash to buy stocks at the bottom</strong> during rebalancing, which generates long-term compounding advantages.
                </div>
                <br><br>
                <strong>Per ${frequencyText.charAt(0).toUpperCase() + frequencyText.slice(1)}:</strong><br>
                Buy ${result.contractsPerPurchase} contracts at $${result.costPerContract.toFixed(2)}/contract = $${result.actualCostPerPurchase.toFixed(2)}
                <br><br>
                <strong>Annual Total:</strong><br>
                ${buyFrequency}x purchases = $${result.totalAnnualCost.toFixed(2)}/year (${((result.totalAnnualCost/portfolio)*100).toFixed(2)}% of portfolio)
                <br><br>
                ${result.coveragePercent < 25
                    ? `<span style="color: #f59e0b;">‚ö†Ô∏è Low coverage (${result.coveragePercent.toFixed(0)}%). Consider increasing budget or buying more frequently.</span>`
                    : result.coveragePercent > 75
                    ? `<span style="color: #10b981;">‚úì Strong coverage (${result.coveragePercent.toFixed(0)}%).</span>`
                    : `Moderate coverage (${result.coveragePercent.toFixed(0)}%).`
                }
                <br><br>
                <span style="color: var(--text-muted); font-size: 0.85em;">
                Note: Assumes optimal timing (${result.activeContractsInCrash} contracts active during crash). Actual coverage varies with crash timing and rolling strikes.
                </span>
            `;

            document.getElementById('explanation').innerHTML = explanation;

            // Calculate exposure capacity (reverse calculation using VOLATILITY-BASED logic)
            // Net profit per contract (after premium) from active contracts in ONE crash
            const strikePrice = Math.floor(spyPrice * (1 - strikeDistance / 100));
            const estimatedOptionPriceAtStrike = strikePrice * 0.12;
            const profitPerContract = (estimatedOptionPriceAtStrike - putPremium) * 100;
            const totalProfit = profitPerContract * result.activeContractsInCrash;

            // At strike distance, portfolio loss = portfolio √ó (strike distance %)
            // For 50% coverage: profit = 0.5 √ó loss = 0.5 √ó portfolio √ó (strike distance %)
            // So: max portfolio = profit / (0.5 √ó strike distance %)
            const targetCoverage = 50; // Target 50% coverage
            const maxPortfolioAt50Coverage = totalProfit / (targetCoverage / 100 * strikeDistance / 100);

            const exposureCapacity = `
                Annual budget: $${result.totalAnnualCost.toFixed(0)} ‚Üí ${result.activeContractsInCrash} active contracts per crash<br>
                Net profit at ${strikeDistance}% drop: $${totalProfit.toLocaleString()} (after premium)<br>
                <br>
                <strong>Portfolio size for ${targetCoverage}% coverage: $${maxPortfolioAt50Coverage.toLocaleString()}</strong>
                <span class="info-icon" onclick="toggleInfo('exposure-info-popup')">‚Ñπ</span>
                <div id="exposure-info-popup" class="info-popup">
                    <strong>The "Buffer" Logic:</strong><br>
                    Calculated by reversing your budget. If your actual portfolio is smaller than this number, you're "Over-Insured." This acts as a buffer against slippage, bid-ask spreads, and timing fuck ups.
                </div>
                <br>
                ${portfolio < maxPortfolioAt50Coverage
                    ? `<span style="color: #f59e0b;">‚ö†Ô∏è Over-insured. Portfolio ($${portfolio.toLocaleString()}) is only ${((portfolio/maxPortfolioAt50Coverage)*100).toFixed(0)}% of target.<br>Options: Scale up to $${maxPortfolioAt50Coverage.toLocaleString()} OR cut budget to $${((result.totalAnnualCost * portfolio / maxPortfolioAt50Coverage)).toFixed(0)}/year</span>`
                    : portfolio > maxPortfolioAt50Coverage * 2
                    ? `<span style="color: #f59e0b;">‚ö†Ô∏è Under-insured. Portfolio ($${portfolio.toLocaleString()}) is ${((portfolio/maxPortfolioAt50Coverage)*100).toFixed(0)}% of target.<br>Option: Increase budget to ~$${((result.totalAnnualCost * portfolio / maxPortfolioAt50Coverage)).toFixed(0)}/year</span>`
                    : `<span style="color: #10b981;">‚úì In range. Portfolio is ${((portfolio/maxPortfolioAt50Coverage)*100).toFixed(0)}% of ${targetCoverage}% coverage target.</span>`
                }
            `;

            document.getElementById('exposure-capacity').innerHTML = exposureCapacity;

            // Calculate historical crash scenarios using actual historical prices
            const crash2008 = calculateCrashScenario('2008 Financial Crisis', 89.53, 157, 68, portfolio, spyPrice, result.activeContractsInCrash, putPremium, strikeDistance);
            const crash2020 = calculateCrashScenario('COVID-19 Crash', 82.69, 339, 218, portfolio, spyPrice, result.activeContractsInCrash, putPremium, strikeDistance);

            document.getElementById('crash-2008').innerHTML = crash2008;
            document.getElementById('crash-2020').innerHTML = crash2020;

            document.getElementById('results').classList.remove('hidden');
        }

        // Refresh data
        async function refreshData() {
            marketData = await fetchMarketData();
            updateMarketDataDisplay();
        }

        // Toggle info popup
        function toggleInfo(popupId) {
            const popup = document.getElementById(popupId);
            if (popup) {
                popup.classList.toggle('show');
            }
        }

        // Event listeners
        document.getElementById('vix-manual').addEventListener('input', () => {
            updateVixMultiplier();
            calculate();
        });
        document.getElementById('spy-manual').addEventListener('input', () => {
            updateMarketDataDisplay();
            calculate();
        });

        // Auto-calculate on any input change
        document.getElementById('portfolio-exposure').addEventListener('input', calculate);
        document.getElementById('per-purchase-budget').addEventListener('input', calculate);
        document.getElementById('buy-frequency').addEventListener('change', calculate);
        document.getElementById('strike-distance').addEventListener('change', () => {
            updateStrikeDisplay();
            calculate();
        });
        document.getElementById('days-to-expiration').addEventListener('change', () => {
            updateStrikeDisplay();
            calculate();
        });
        document.getElementById('put-premium').addEventListener('input', calculate);

        // Initialize
        initTheme();
        window.addEventListener('load', async () => {
            marketData = await fetchMarketData();
            updateMarketDataDisplay();
            calculate(); // Initial calculation
        });
    </script>
</body>
</html>
