<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microcosma: ReTail Risk Hedgehog</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶î</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.bunny.net/css?family=jetbrains-mono:400,700" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        * {
            font-family: 'JetBrains Mono', monospace;
        }

        :root {
            --bg-start: #fafafa;
            --bg-end: #f5f5f5;
            --text: #1a1a1a;
            --text-muted: #666;
            --border: #e0e0e0;
            --card-bg: #ffffff;
            --gradient-1: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
            --gradient-2: linear-gradient(135deg, #f472b6 0%, #fb923c 100%);
            --gradient-3: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --input-bg: #fafafa;
            --shadow: rgba(0, 0, 0, 0.05);
            --accent: #a78bfa;
        }

        [data-theme="dark"] {
            --bg-start: #0a0a0a;
            --bg-end: #1a1a1a;
            --text: #e5e5e5;
            --text-muted: #a0a0a0;
            --border: #333;
            --card-bg: #1f1f1f;
            --input-bg: #2a2a2a;
            --shadow: rgba(255, 255, 255, 0.03);
        }

        body {
            background: linear-gradient(to bottom, var(--bg-start), var(--bg-end));
            color: var(--text);
            min-height: 100vh;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px var(--shadow);
        }

        .gradient-text {
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 1.5rem;
            transition: transform 0.2s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        input[type="number"] {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            background: var(--gradient-1);
            transition: transform 0.2s, opacity 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--gradient-2);
        }

        summary {
            cursor: pointer;
            user-select: none;
        }

        summary:hover {
            color: var(--text);
        }
    </style>
</head>
<body>
    <div class="max-w-3xl mx-auto px-6 py-12">

        <!-- Header -->
        <header class="mb-16">
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-6">
                    <div class="text-8xl">ü¶î</div>
                    <div>
                        <h1 class="text-5xl font-bold mb-2">
                            <span class="gradient-text">Microcosma</span>
                        </h1>
                        <p class="text-sm" style="color: var(--text-muted);">ReTail Risk Hedgehog</p>
                    </div>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <span id="theme-icon">üåô</span>
                </div>
            </div>

            <p style="color: var(--text-muted); line-height: 1.8; max-width: 60ch;">
                A systematic tool for implementing a disciplined, retail-scale black swan insurance strategy.
                Inspired by Taleb and Spitznagel. Continuously pay a small premium for deep OTM SPY puts.
                Most years they expire worthless. When catastrophe strikes, maybe you offset some losses.
            </p>
        </header>

        <!-- Market Data Card -->
        <section class="card rounded-lg p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6">Market Data</h2>

            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <div class="text-xs mb-2" style="color: var(--text-muted);">SPY Price</div>
                    <div class="text-3xl font-bold" id="spy-price">--</div>
                    <div class="text-xs mt-1" style="color: var(--text-muted);">Previous Close</div>
                </div>
                <div>
                    <div class="text-xs mb-2" style="color: var(--text-muted);">VIX</div>
                    <input
                        type="number"
                        id="vix-manual"
                        value="16"
                        step="0.1"
                        class="text-3xl font-bold w-full rounded px-2 py-1"
                        placeholder="16">
                    <div class="text-xs mt-1" style="color: var(--text-muted);">Manual Entry</div>
                </div>
                <div>
                    <div class="text-xs mb-2" style="color: var(--text-muted);">Budget Multiplier</div>
                    <div class="text-3xl font-bold" id="vix-multiplier">--</div>
                    <div class="text-xs mt-1" style="color: var(--text-muted);">VIX-Adjusted</div>
                </div>
            </div>

            <div class="p-3 rounded text-xs mb-4" style="background: var(--input-bg);">
                <strong>VIX Budget Rule:</strong> VIX &lt;20 = 100% budget | VIX 20-30 = 75% | VIX &gt;30 = 50%<br>
                Buy more insurance when it's cheap, less when expensive.
            </div>

            <p class="text-xs mb-4" style="color: var(--text-muted);">
                Check current VIX at CBOE.com. Free tier = previous close for SPY.
            </p>

            <button onclick="refreshData()" class="btn text-white font-bold py-3 px-6 rounded-lg w-full mb-4">
                Refresh SPY Data
            </button>

            <details class="text-sm">
                <summary style="color: var(--text-muted);">Override SPY manually</summary>
                <div class="mt-3">
                    <input
                        type="number"
                        id="spy-manual"
                        step="0.01"
                        class="w-full rounded px-4 py-2"
                        placeholder="Leave blank to use API data">
                </div>
            </details>
        </section>

        <!-- Calculator Card -->
        <section class="card rounded-lg p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6">Your Hedge</h2>

            <div class="space-y-6">
                <div>
                    <label class="block text-sm mb-2" style="color: var(--text-muted);">Portfolio SPY Exposure ($)</label>
                    <input
                        type="number"
                        id="portfolio-exposure"
                        value="100000"
                        class="w-full rounded px-4 py-3 text-lg font-bold">
                    <p class="text-xs mt-1" style="color: var(--text-muted);">
                        Value of S&P 500 holdings you want to hedge
                    </p>
                </div>

                <div>
                    <label class="block text-sm mb-2" style="color: var(--text-muted);">Max Spend Per Purchase ($)</label>
                    <input
                        type="number"
                        id="per-purchase-budget"
                        value="250"
                        class="w-full rounded px-4 py-3 text-lg font-bold">
                    <p class="text-xs mt-1" style="color: var(--text-muted);">
                        How much you want to spend each time you buy
                    </p>
                </div>

                <div>
                    <label class="block text-sm mb-2" style="color: var(--text-muted);">Buy Frequency</label>
                    <select id="buy-frequency" class="w-full rounded px-4 py-3 text-lg font-bold" style="background: var(--input-bg); border: 1px solid var(--border); color: var(--text);">
                        <option value="12">Monthly</option>
                        <option value="4" selected>Quarterly</option>
                        <option value="2">Semi-Annual</option>
                        <option value="1">Annual</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm mb-2" style="color: var(--text-muted);">Strike Distance</label>
                    <select id="strike-distance" class="w-full rounded px-4 py-3 text-lg font-bold" style="background: var(--input-bg); border: 1px solid var(--border); color: var(--text);">
                        <option value="10">10% OTM</option>
                        <option value="20">20% OTM</option>
                        <option value="30" selected>30% OTM (Black Swan)</option>
                        <option value="40">40% OTM (Deep OTM)</option>
                        <option value="50">50% OTM (Extreme)</option>
                    </select>
                    <p class="text-xs mt-1" style="color: var(--text-muted);" id="strike-price-display">
                        Strike: --
                    </p>
                </div>

                <div>
                    <label class="block text-sm mb-2" style="color: var(--text-muted);">Days to Expiration</label>
                    <select id="days-to-expiration" class="w-full rounded px-4 py-3 text-lg font-bold" style="background: var(--input-bg); border: 1px solid var(--border); color: var(--text);">
                        <option value="30">30 Days</option>
                        <option value="60">60 Days</option>
                        <option value="90" selected>90 Days</option>
                        <option value="180">180 Days</option>
                    </select>
                </div>

                <div class="card p-4" style="background: var(--input-bg);">
                    <p class="text-xs mb-2" style="color: var(--text-muted);">
                        Look up this contract on <a href="#" id="yahoo-link" target="_blank" class="underline" style="color: var(--accent);">Yahoo Finance</a>
                    </p>
                    <div class="text-sm font-bold mb-2" id="contract-description">--</div>
                    <label class="block text-xs mb-1" style="color: var(--text-muted);">Ask Price (per share, will auto-multiply by 100)</label>
                    <input
                        type="number"
                        id="put-premium"
                        value="0.50"
                        step="0.01"
                        placeholder="e.g., 0.64"
                        class="w-full rounded px-3 py-2 text-base font-bold">
                </div>
            </div>

        </section>

        <!-- Results Card -->
        <section id="results" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="card rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4 gradient-text">Per Purchase</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Contracts to Buy</div>
                            <div class="text-3xl font-bold" id="contracts-needed">--</div>
                        </div>
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Cost</div>
                            <div class="text-3xl font-bold" id="total-capital">--</div>
                        </div>
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Budget Allocated</div>
                            <div class="text-lg" id="adjusted-budget">--</div>
                        </div>
                    </div>
                </div>

                <div class="card rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4 gradient-text">Annual Total</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Total Contracts</div>
                            <div class="text-3xl font-bold" id="max-exposure">--</div>
                        </div>
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Total Annual Cost</div>
                            <div class="text-3xl font-bold" id="contracts-affordable">--</div>
                        </div>
                        <div>
                            <div class="text-xs" style="color: var(--text-muted);">Protection Level</div>
                            <div class="text-lg" id="coverage-info">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card rounded-lg p-6 mb-8">
                <h3 class="text-lg font-bold mb-3">Summary</h3>
                <div class="text-sm leading-relaxed" style="color: var(--text-muted);" id="explanation"></div>
            </div>

            <div class="card rounded-lg p-6 mb-8">
                <h3 class="text-lg font-bold mb-4 gradient-text">Exposure Capacity</h3>
                <p class="text-xs mb-4" style="color: var(--text-muted);">
                    With your budget, what's the maximum portfolio size you can hedge?
                </p>
                <div class="text-sm leading-relaxed" style="color: var(--text-muted);" id="exposure-capacity"></div>
            </div>

            <!-- Historical Crash Scenarios -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-bold mb-4 gradient-text">Historical Crash Scenarios</h3>
                <p class="text-xs mb-6" style="color: var(--text-muted);">
                    What would your hedge have returned during actual market catastrophes?
                </p>

                <div class="space-y-6">
                    <!-- 2008 Financial Crisis -->
                    <div class="p-4 rounded" style="background: var(--input-bg); border-left: 4px solid #ec4899;">
                        <div class="mb-3">
                            <div class="text-sm font-bold">2008 Financial Crisis</div>
                            <div class="text-xs" style="color: var(--text-muted);">Oct 2007 peak ‚Üí Mar 2009 trough</div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-xs mb-3">
                            <div>
                                <div style="color: var(--text-muted);">VIX Peak</div>
                                <div class="font-bold">89.53</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted);">SPY Peak</div>
                                <div class="font-bold">$157</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted);">SPY Bottom</div>
                                <div class="font-bold">$68</div>
                            </div>
                        </div>
                        <div class="text-sm leading-relaxed" id="crash-2008"></div>
                    </div>

                    <!-- COVID-19 Crash -->
                    <div class="p-4 rounded" style="background: var(--input-bg); border-left: 4px solid #f472b6;">
                        <div class="mb-3">
                            <div class="text-sm font-bold">COVID-19 Crash</div>
                            <div class="text-xs" style="color: var(--text-muted);">Feb 2020 peak ‚Üí Mar 2020 trough</div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-xs mb-3">
                            <div>
                                <div style="color: var(--text-muted);">VIX Peak</div>
                                <div class="font-bold">82.69</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted);">SPY Peak</div>
                                <div class="font-bold">$339</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted);">SPY Bottom</div>
                                <div class="font-bold">$218</div>
                            </div>
                        </div>
                        <div class="text-sm leading-relaxed" id="crash-2020"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer with Disclaimer -->
        <footer class="mt-16 pt-8 border-t" style="border-color: var(--border);">
            <details class="mb-8">
                <summary class="text-lg font-bold mb-4" style="color: var(--text-muted);">
                    Disclaimer: Read And Re-Read This
                </summary>
                <div class="mt-4 space-y-4 text-sm leading-relaxed max-w-65ch" style="color: var(--text-muted);">
                    <p>
                        Options trading is dangerous. You can lose 100% of your premium. Deep OTM puts expire
                        worthless more often than not. That is the point.
                    </p>

                    <p>
                        This is insurance, not a get-rich-quick scheme. You pay a premium every year for protection
                        you will probably never collect on. Like Taleb says: you look like an idiot for years
                        until the day you look like a genius. Can you handle looking like an idiot?
                    </p>

                    <p>
                        You need to understand convexity. You need to understand volatility. You need to understand
                        that market makers are not your friends. You need to understand that liquidity can disappear
                        faster than your unrealized gains in a crash.
                    </p>

                    <p>
                        <strong>This tool does NOT:</strong> Place trades for you. Guarantee any returns.
                        Constitute financial advice. Protect you from your own stupidity. Account for taxes,
                        commissions, slippage, or the heat death of the universe.
                    </p>

                    <p>
                        <strong>What this IS:</strong> A calculator for implementing a fairly pathetic Taleb/Spitznagel-style
                        tail hedge at retail (micro)scale. You set a budget. You buy disaster insurance. Most months/years
                        it expires worthless (you lose all your money). When the apocalypse comes, you might offset some losses.
                    </p>

                    <p>
                        If you do not know what vega, skew, or gamma mean, you have no business trading options.
                        Go read Taleb's <a href="https://bookshop.org/a/89518/9780471152804" target="_blank" class="underline" style="color: var(--accent);">Dynamic Hedging</a> and Spitznagel's <a href="https://bookshop.org/a/89518/9781118347034" target="_blank" class="underline" style="color: var(--accent);">The Dao of Capital</a> and <a href="https://bookshop.org/a/89518/9781119401797" target="_blank" class="underline" style="color: var(--accent);">Safe Haven</a> first.
                        Seriously. Close this tab and go read.
                    </p>

                    <p>
                        <strong>Final warning:</strong> This strategy can and will lead to total financial
                        obliteration if you mess it up. Use at your own risk. You are  responsible for
                        your losses, margin calls, and  existential crises. Not this tiny app.
                    </p>
                </div>
            </details>

            <div class="text-center text-sm" style="color: var(--text-muted);">
                <p class="mb-2">Built with conviction. Hedged with discipline. ü¶î</p>
                <p>Not financial advice. For educational purposes only.</p>
                <p class="mt-4 text-xs">Last updated: <span id="last-updated">Never</span></p>
            </div>
        </footer>
    </div>

    <script>
        // Theme management
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            document.getElementById('theme-icon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme based on system preference or saved preference
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('theme-icon').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // State
        let marketData = {
            spyPrice: null,
            vix: null,
            vixMultiplier: null,
            lastUpdated: null
        };

        // VIX-Based Budget Adjustment
        function calculateVixMultiplier(vix) {
            if (vix < 20) return 1.0;
            if (vix >= 20 && vix <= 30) return 0.75;
            return 0.5;
        }

        // Fetch real market data from Massive API
        async function fetchMarketData() {
            try {
                const spyResponse = await fetch(`${CONFIG.MASSIVE_BASE_URL}/v2/aggs/ticker/${CONFIG.SYMBOLS.SPY}/prev?adjusted=true&apiKey=${CONFIG.MASSIVE_API_KEY}`);

                if (!spyResponse.ok) {
                    const errorText = await spyResponse.text();
                    throw new Error(`Failed to fetch SPY data: ${spyResponse.status}`);
                }

                const spyData = await spyResponse.json();
                const spyPrice = spyData.results?.[0]?.c;

                if (!spyPrice) {
                    throw new Error('No SPY price data available');
                }

                const vixInput = document.getElementById('vix-manual');
                const vixValue = parseFloat(vixInput.value) || 16;

                return {
                    spyPrice: spyPrice,
                    vix: vixValue,
                    vixMultiplier: calculateVixMultiplier(vixValue),
                    lastUpdated: new Date()
                };
            } catch (error) {
                console.error('Error fetching market data:', error);
                alert(`Failed to fetch market data: ${error.message}\n\nPlease check your API key or enter data manually.`);

                const vixInput = document.getElementById('vix-manual');
                const spyInput = document.getElementById('spy-manual');

                const vixValue = parseFloat(vixInput.value) || 16;
                const spyPrice = parseFloat(spyInput.value) || 600;

                return {
                    spyPrice: spyPrice,
                    vix: vixValue,
                    vixMultiplier: calculateVixMultiplier(vixValue),
                    lastUpdated: new Date()
                };
            }
        }

        // Update market data display
        function updateMarketDataDisplay() {
            if (!marketData.spyPrice) return;

            const spyManualInput = document.getElementById('spy-manual');
            const displayPrice = spyManualInput.value ? parseFloat(spyManualInput.value) : marketData.spyPrice;
            document.getElementById('spy-price').textContent = `$${displayPrice.toFixed(2)}`;

            const vixInput = document.getElementById('vix-manual');
            const currentVix = parseFloat(vixInput.value) || marketData.vix;
            const multiplier = calculateVixMultiplier(currentVix);

            document.getElementById('vix-multiplier').textContent = `${(multiplier * 100).toFixed(0)}%`;
            document.getElementById('last-updated').textContent = marketData.lastUpdated.toLocaleString();

            updateStrikeDisplay();
        }

        // Update strike price display and Yahoo link
        function updateStrikeDisplay() {
            const spyManualInput = document.getElementById('spy-manual');
            const spyPrice = spyManualInput.value ? parseFloat(spyManualInput.value) : marketData.spyPrice;

            if (!spyPrice) return;

            const strikeDistance = parseFloat(document.getElementById('strike-distance').value);
            const daysToExp = document.getElementById('days-to-expiration').value;

            const strikePrice = Math.floor(spyPrice * (1 - strikeDistance / 100));

            // Calculate approximate expiration date
            const today = new Date();
            const expirationDate = new Date(today);
            expirationDate.setDate(today.getDate() + parseInt(daysToExp));

            // Format for display
            const expirationString = expirationDate.toISOString().split('T')[0];

            document.getElementById('strike-price-display').textContent = `Strike: $${strikePrice} (${strikeDistance}% below current)`;
            document.getElementById('contract-description').textContent = `SPY ${expirationString} $${strikePrice}P`;

            // Generate Yahoo Finance link
            const yahooLink = `https://finance.yahoo.com/quote/SPY/options?date=${Math.floor(expirationDate.getTime() / 1000)}`;
            document.getElementById('yahoo-link').href = yahooLink;
        }

        // Update VIX multiplier when VIX input changes
        function updateVixMultiplier() {
            const vixInput = document.getElementById('vix-manual');
            const vixValue = parseFloat(vixInput.value);
            if (vixValue && vixValue > 0) {
                marketData.vix = vixValue;
                marketData.vixMultiplier = calculateVixMultiplier(vixValue);
                document.getElementById('vix-multiplier').textContent = `${(marketData.vixMultiplier * 100).toFixed(0)}%`;
            }
        }

        // Core calculation: fixed
        function calculateHedge(portfolio, perPurchaseBudget, buyFrequency, putPremiumPerShare, vixMultiplier, strikeDistance, spyPrice) {
            // VIX adjustment: scale down purchases when VIX is high (insurance expensive)
            const vixAdjustedBudget = perPurchaseBudget * vixMultiplier;

            // Convert per-share price to per-contract price (1 contract = 100 shares)
            const costPerContract = putPremiumPerShare * 100;

            // How many contracts can you afford per purchase?
            const contractsPerPurchase = Math.floor(vixAdjustedBudget / costPerContract);

            // Actual cost per purchase
            const actualCostPerPurchase = contractsPerPurchase * costPerContract;

            // Annual totals
            const totalAnnualContracts = contractsPerPurchase * buyFrequency;
            const totalAnnualCost = actualCostPerPurchase * buyFrequency;

            // Calculate coverage
            const strikePrice = Math.floor(spyPrice * (1 - strikeDistance / 100));
            const portfolioLossAtStrike = portfolio * (strikeDistance / 100);

            // Max payout per contract at strike = (SPY start - strike) * 100
            const payoutPerContract = (spyPrice - strikePrice) * 100;
            const totalMaxPayout = payoutPerContract * totalAnnualContracts;

            // What % of portfolio loss is covered?
            const coveragePercent = (totalMaxPayout / portfolioLossAtStrike) * 100;

            return {
                contractsPerPurchase,
                actualCostPerPurchase,
                vixAdjustedBudget,
                totalAnnualContracts,
                totalAnnualCost,
                costPerContract,
                coveragePercent,
                totalMaxPayout,
                portfolioLossAtStrike
            };
        }

        // Calculate historical crash scenario returns using actual historical SPY prices
        function calculateCrashScenario(crashName, crashVix, historicalPeakSPY, historicalBottomSPY, portfolio, currentSPY, totalAnnualContracts, totalAnnualCost, strikeDistance) {
            const strikePrice = Math.floor(historicalPeakSPY * (1 - strikeDistance / 100));
            const historicalDropPercent = ((historicalPeakSPY - historicalBottomSPY) / historicalPeakSPY) * 100;

            if (historicalBottomSPY >= strikePrice) {
                return `<span style="color: var(--text-muted);">-${historicalDropPercent.toFixed(0)}% drop. Strike not hit.</span>`;
            }

            const intrinsicValue = strikePrice - historicalBottomSPY;
            const payoutPerContract = intrinsicValue * 100;
            const totalPayout = payoutPerContract * totalAnnualContracts;
            const portfolioLoss = portfolio * (historicalDropPercent / 100);
            const recoveryPercent = (totalPayout / portfolioLoss) * 100;

            return `
                -${historicalDropPercent.toFixed(0)}% drop | Strike: $${strikePrice}<br>
                Payout: $${totalPayout.toLocaleString()} | Recovered ${recoveryPercent.toFixed(0)}% of loss
            `;
        }

        // Calculate and display results (auto-updates)
        function calculate() {
            const portfolio = parseFloat(document.getElementById('portfolio-exposure').value);
            const perPurchaseBudget = parseFloat(document.getElementById('per-purchase-budget').value);
            const buyFrequency = parseFloat(document.getElementById('buy-frequency').value);
            const strikeDistance = parseFloat(document.getElementById('strike-distance').value);
            const putPremium = parseFloat(document.getElementById('put-premium').value);

            if (!marketData.vix || !portfolio || !perPurchaseBudget || !buyFrequency || !strikeDistance || !putPremium || !marketData.spyPrice) {
                return;
            }

            const spyManualInput = document.getElementById('spy-manual');
            const spyPrice = spyManualInput.value ? parseFloat(spyManualInput.value) : marketData.spyPrice;

            const result = calculateHedge(portfolio, perPurchaseBudget, buyFrequency, putPremium, marketData.vixMultiplier, strikeDistance, spyPrice);

            // Update results display
            document.getElementById('contracts-needed').textContent = result.contractsPerPurchase;
            document.getElementById('total-capital').textContent = `$${result.actualCostPerPurchase.toFixed(2)}`;
            document.getElementById('adjusted-budget').textContent = `$${result.vixAdjustedBudget.toFixed(2)}`;

            document.getElementById('max-exposure').textContent = result.totalAnnualContracts;
            document.getElementById('contracts-affordable').textContent = `$${result.totalAnnualCost.toFixed(2)}`;
            document.getElementById('coverage-info').textContent = `${result.coveragePercent.toFixed(0)}% of loss`;

            const frequencyText = buyFrequency == 12 ? 'month' : buyFrequency == 4 ? 'quarter' : buyFrequency == 2 ? 'half-year' : 'year';

            const explanation = `
                <strong>Portfolio Coverage:</strong><br>
                Portfolio: $${portfolio.toLocaleString()} | Loss at ${strikeDistance}% crash: $${result.portfolioLossAtStrike.toLocaleString()}<br>
                Max hedge payout: $${result.totalMaxPayout.toLocaleString()} = <strong>${result.coveragePercent.toFixed(1)}% coverage</strong>
                <br><br>
                <strong>Per ${frequencyText.charAt(0).toUpperCase() + frequencyText.slice(1)}:</strong><br>
                Buy ${result.contractsPerPurchase} contracts at $${result.costPerContract.toFixed(2)}/contract = $${result.actualCostPerPurchase.toFixed(2)}
                <br><br>
                <strong>Annual Total:</strong><br>
                ${result.totalAnnualContracts} contracts, $${result.totalAnnualCost.toFixed(2)}/year (${((result.totalAnnualCost/portfolio)*100).toFixed(2)}% of portfolio)
                <br><br>
                ${result.coveragePercent < 25
                    ? `<span style="color: #f59e0b;">‚ö†Ô∏è Low coverage (${result.coveragePercent.toFixed(0)}%). Consider increasing budget or buying more frequently.</span>`
                    : result.coveragePercent > 75
                    ? `<span style="color: #10b981;">‚úì Strong coverage (${result.coveragePercent.toFixed(0)}%).</span>`
                    : `Moderate coverage (${result.coveragePercent.toFixed(0)}%).`
                }
            `;

            document.getElementById('explanation').innerHTML = explanation;

            // Calculate exposure capacity (reverse calculation)
            // Max payout from your annual contracts
            const strikePrice = Math.floor(spyPrice * (1 - strikeDistance / 100));
            const maxPayoutPerContract = (spyPrice - strikePrice) * 100;
            const totalMaxPayout = maxPayoutPerContract * result.totalAnnualContracts;

            // At strike distance, portfolio loss = portfolio √ó (strike distance %)
            // For 50% coverage: payout = 0.5 √ó loss = 0.5 √ó portfolio √ó (strike distance %)
            // So: max portfolio = payout / (0.5 √ó strike distance %)
            const targetCoverage = 50; // Target 50% coverage
            const maxPortfolioAt50Coverage = totalMaxPayout / (targetCoverage / 100 * strikeDistance / 100);

            const exposureCapacity = `
                Annual budget: $${result.totalAnnualCost.toFixed(0)} ‚Üí ${result.totalAnnualContracts} contracts<br>
                Max payout at ${strikeDistance}% drop: $${totalMaxPayout.toLocaleString()}<br>
                <br>
                <strong>Portfolio size for ${targetCoverage}% coverage: $${maxPortfolioAt50Coverage.toLocaleString()}</strong><br>
                ${portfolio > maxPortfolioAt50Coverage
                    ? `<span style="color: #f59e0b;">‚ö†Ô∏è Over-insured. Current ($${portfolio.toLocaleString()}) is ${((portfolio/maxPortfolioAt50Coverage)*100).toFixed(0)}% of target.<br>Options: Scale up to $${maxPortfolioAt50Coverage.toLocaleString()} OR cut budget to $${((result.totalAnnualCost * portfolio / maxPortfolioAt50Coverage)).toFixed(0)}/year</span>`
                    : portfolio < maxPortfolioAt50Coverage * 0.5
                    ? `<span style="color: #f59e0b;">‚ö†Ô∏è Under-insured. Current ($${portfolio.toLocaleString()}) is ${((portfolio/maxPortfolioAt50Coverage)*100).toFixed(0)}% of target.<br>Option: Increase budget to ~$${((result.totalAnnualCost * maxPortfolioAt50Coverage / portfolio)).toFixed(0)}/year</span>`
                    : `<span style="color: #10b981;">‚úì In range. Portfolio is ${((portfolio/maxPortfolioAt50Coverage)*100).toFixed(0)}% of ${targetCoverage}% coverage target.</span>`
                }
            `;

            document.getElementById('exposure-capacity').innerHTML = exposureCapacity;

            // Calculate historical crash scenarios using actual historical prices
            const crash2008 = calculateCrashScenario('2008 Financial Crisis', 89.53, 157, 68, portfolio, spyPrice, result.totalAnnualContracts, result.totalAnnualCost, strikeDistance);
            const crash2020 = calculateCrashScenario('COVID-19 Crash', 82.69, 339, 218, portfolio, spyPrice, result.totalAnnualContracts, result.totalAnnualCost, strikeDistance);

            document.getElementById('crash-2008').innerHTML = crash2008;
            document.getElementById('crash-2020').innerHTML = crash2020;

            document.getElementById('results').classList.remove('hidden');
        }

        // Refresh data
        async function refreshData() {
            marketData = await fetchMarketData();
            updateMarketDataDisplay();
        }

        // Event listeners
        document.getElementById('vix-manual').addEventListener('input', () => {
            updateVixMultiplier();
            calculate();
        });
        document.getElementById('spy-manual').addEventListener('input', () => {
            updateMarketDataDisplay();
            calculate();
        });

        // Auto-calculate on any input change
        document.getElementById('portfolio-exposure').addEventListener('input', calculate);
        document.getElementById('per-purchase-budget').addEventListener('input', calculate);
        document.getElementById('buy-frequency').addEventListener('change', calculate);
        document.getElementById('strike-distance').addEventListener('change', () => {
            updateStrikeDisplay();
            calculate();
        });
        document.getElementById('days-to-expiration').addEventListener('change', () => {
            updateStrikeDisplay();
            calculate();
        });
        document.getElementById('put-premium').addEventListener('input', calculate);

        // Initialize
        initTheme();
        window.addEventListener('load', async () => {
            marketData = await fetchMarketData();
            updateMarketDataDisplay();
            calculate(); // Initial calculation
        });
    </script>
</body>
</html>
